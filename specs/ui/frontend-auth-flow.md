# Frontend Authentication Flow Specification
**Todo App – Hackathon II – Phase II**

**Version**: 1.0
**Status**: Effective
**Governing Specs**:
- `.specify/memory/constitution.md` - Supreme authority
- `/specs/ui/frontend-architecture.md` - Frontend architecture
- `/specs/ui/pages.md` - Page structure
- `/specs/ui/frontend-components-spec.md` - Component responsibilities
- `/specs/api/frontend-api-client.md` - API client integration
- `/specs/skills/authentication-skill.md` - Authentication reasoning logic

---

## 1. Purpose of Authentication Flow

This specification defines the conceptual flow of authentication operations in Todo App Phase II. It establishes how frontend components, state management, API client, and notification systems coordinate to provide secure, multi-user authentication while maintaining a seamless user experience.

**Primary Objectives:**
- Ensure secure user login and signup processes
- Integrate JWT token management with frontend state seamlessly
- Coordinate frontend state (AuthProvider), API client (token attachment), and notifications (user feedback)
- Enforce multi-user data isolation at the flow level
- Provide clear, deterministic error handling and user feedback

**Non-Objectives:**
- This is NOT an implementation guide (use Frontend API Client Skill for code generation)
- This does NOT contain actual JWT validation logic (backend responsibility per Authentication Skill)
- This does NOT define Better Auth server implementation

---

## 2. Relationship with Constitution, Skills & Agents

### 2.1 Constitution Compliance

**From `.specify/memory/constitution.md`:**
- **Spec-Driven Development**: Authentication flows must reference specifications
- **Zero Manual Coding**: Flows generated by agents using skills
- **Multi-User Isolation**: All flows enforce user-specific access
- **Security First**: JWT tokens handled securely, no credential exposure
- **Technology Stack**: Next.js, TypeScript, Tailwind CSS

### 2.2 Skill Responsibilities

**Authentication Skill** (`/specs/skills/authentication-skill.md`):
- Provides reasoning for authentication decisions
- Defines token lifecycle management rules
- Enforces session security policies
- Validates authorization requirements

**Frontend API Client Skill** (`/specs/skills/frontend-api-client-skill.md`):
- Generates API client functions for auth endpoints
- Handles JWT token attachment to requests
- Manages token storage and retrieval
- Handles 401 Unauthorized responses (token expiry)

**Frontend State Management Skill** (`/specs/skills/frontend-state-management-skill.md`):
- Designs AuthProvider state structure
- Defines login/logout methods
- Plans authentication state updates

**Frontend Notification Skill** (`/specs/skills/frontend-notification-skill.md`):
- Generates toast notifications for auth events
- Displays success/error messages to users

**Frontend Form Handling Skill**:
- Validates login and signup forms
- Provides field-level error feedback

**Frontend Routing Skill**:
- Manages route transitions (login → dashboard)
- Handles protected route redirects

### 2.3 Agent Orchestration

**Frontend Implementation Agent**:
- Invokes Authentication Skill for auth logic reasoning
- Invokes Frontend API Client Skill for auth API functions
- Invokes Frontend State Management Skill for AuthProvider
- Invokes Frontend Notification Skill for user feedback
- Orchestrates multi-step flows (login → fetch tasks → update state → notify)

**Plan Agent**:
- Designs authentication flow architecture
- Plans state updates and transitions
- Determines error handling strategies

---

## 3. Authentication Flow Steps (Conceptual)

### 3.1 Signup Flow

**Purpose**: Register new user account

**Flow Conceptual Steps:**

1. **Entry Point**
   - User navigates to `/register` page
   - RegisterPage component renders

2. **User Input**
   - User fills registration form
   - Form fields: email, name, password, confirm password

3. **Form Validation (Client-Side)**
   - **Skill**: Frontend Form Handling Skill
   - Validate email format
   - Validate password length (min 8 characters)
   - Validate password confirmation matches password
   - Show inline validation errors

4. **Form Submission**
   - User clicks "Create Account" button
   - RegisterPage calls API client register function

5. **API Request**
   - **Skill**: Frontend API Client Skill (api.register())
   - **Agent**: Frontend Implementation Agent
   - Send POST request to `/api/auth/register`
   - Request body: `{ email, name, password }`
   - No JWT token required (public endpoint)

6. **Backend Processing (Authentication Skill)**
   - Validate email uniqueness
   - Validate password policies
   - Hash password (bcrypt, cost factor 12)
   - Create user record in database
   - Return user data or error

7. **Response Handling**
   - **Success (201)**:
     - Receive user data: `{ id, email, name, created_at }`
     - API client transforms response (snake_case → camelCase)
     - RegisterPage receives success response
   - **Failure (400, 409)**:
     - Receive error response: `{ detail, error_code, field }`
     - API client transforms response to error object
     - RegisterPage receives error object

8. **State Updates**
   - **Skill**: Frontend State Management Skill
   - **Agent**: Frontend Implementation Agent
   - **Success**: No state update (user not authenticated yet)
   - **Failure**: Display error messages on form fields

9. **Notifications**
   - **Skill**: Frontend Notification Skill
   - **Agent**: Frontend Implementation Agent
   - **Success**: Show success toast: "Account created successfully"
   - **Failure**: Show error toast with error message
   - **Success + Success Toast**: Redirect to `/login` page after short delay

10. **Redirect**
    - **Skill**: Frontend Routing Skill
    - **Agent**: Frontend Implementation Agent
    - Navigate to `/login` page
    - User enters login credentials to authenticate

**Error Handling:**
- **Email already exists (409)**: Show error on email field
- **Password too short (400)**: Show error on password field
- **Password mismatch (400)**: Show error on confirm password field
- **Server error (500)**: Show generic error with retry option

---

### 3.2 Login Flow

**Purpose**: Authenticate existing user

**Flow Conceptual Steps:**

1. **Entry Point**
   - User navigates to `/login` page
   - LoginPage component renders

2. **User Input**
   - User fills login form
   - Form fields: email, password

3. **Form Validation (Client-Side)**
   - **Skill**: Frontend Form Handling Skill
   - Validate email format
   - Validate password not empty
   - Show inline validation errors

4. **Form Submission**
   - User clicks "Login" button
   - LoginPage calls API client login function

5. **API Request**
   - **Skill**: Frontend API Client Skill (api.login())
   - **Agent**: Frontend Implementation Agent
   - Send POST request to `/api/auth/login`
   - Request body: `{ email, password }`
   - No JWT token required (public endpoint)

6. **Backend Processing (Authentication Skill)**
   - Retrieve user by email
   - Verify password hash matches
   - Generate JWT token (HS256, 24-hour expiration)
   - Extract user data for token claims
   - Return login response or error

7. **Response Handling**
   - **Success (200)**:
     - Receive login response: `{ access_token, token_type, user }`
     - API client transforms response (snake_case → camelCase)
     - API client stores JWT token in `localStorage.getItem('auth_token')`
   - **Failure (400, 401)**:
     - Receive error response: `{ detail, error_code }`
     - API client transforms response to error object
     - LoginPage receives error object

8. **State Updates**
   - **Skill**: Frontend State Management Skill
   - **Agent**: Frontend Implementation Agent
   - **Success**:
     - AuthProvider.login() called
     - Auth state updates:
       - `user`: User object (from response)
       - `loading`: false
       - `isAuthenticated`: true
   - **Failure**:
     - No state update
     - Show error message on form

9. **Notifications**
   - **Skill**: Frontend Notification Skill
   - **Agent**: Frontend Implementation Agent
   - **Success**: Show success toast: "Welcome back, [user name]!"
   - **Failure**: Show error toast: "Invalid email or password"

10. **Redirect**
    - **Skill**: Frontend Routing Skill
    - **Agent**: Frontend Implementation Agent
    - **Success**: Navigate to `/` (dashboard)
    - **Failure**: Remain on `/login` page

**Error Handling:**
- **Invalid credentials (401)**: Show error: "Invalid email or password"
- **Server error (500)**: Show generic error with retry option
- **Network error**: Show offline/error message with retry option

---

### 3.3 Logout Flow

**Purpose**: Terminate user session

**Flow Conceptual Steps:**

1. **Entry Point**
   - User clicks "Logout" button in Header component
   - Triggered from any authenticated page

2. **Logout Confirmation** (Optional Enhancement)
   - Show confirmation dialog
   - User confirms logout

3. **State Updates**
   - **Skill**: Frontend State Management Skill
   - **Agent**: Frontend Implementation Agent
   - AuthProvider.logout() called
   - Auth state updates:
     - `user`: null
     - `loading`: false
     - `isAuthenticated`: false

4. **Token Cleanup**
   - **Skill**: Frontend API Client Skill
   - **Agent**: Frontend Implementation Agent
   - Remove JWT token from `localStorage.removeItem('auth_token')`

5. **Notifications**
   - **Skill**: Frontend Notification Skill
   - **Agent**: Frontend Implementation Agent
   - Show success toast: "Logged out successfully"

6. **Redirect**
   - **Skill**: Frontend Routing Skill
   - **Agent**: Frontend Implementation Agent
   - Navigate to `/login` page

7. **Post-Logout State**
   - All task data cleared from local state
   - All filters reset to defaults
   - User cannot access protected routes (redirects to login)

---

### 3.4 Session Refresh (Auto-Login)

**Purpose**: Restore user session on app load

**Flow Conceptual Steps:**

1. **App Initialization**
   - Root layout mounts
   - AuthProvider initializes

2. **Token Check**
   - **Skill**: Frontend API Client Skill
   - **Agent**: Frontend Implementation Agent
   - Retrieve token from `localStorage.getItem('auth_token')`

3. **Token Validation** (Conceptual)
   - **Backend Responsibility (Authentication Skill)**:
     - Validate JWT token signature
     - Check token expiration
     - Extract user_id from token claims
   - **Frontend Responsibility**:
     - If token exists, decode to extract user data (or fetch from backend)
     - If token is missing/expired, treat as unauthenticated

4. **State Updates**
   - **Skill**: Frontend State Management Skill
   - **Agent**: Frontend Implementation Agent
   - **Valid Token**:
     - AuthProvider sets `user`: User object
     - AuthProvider sets `loading`: false
     - AuthProvider sets `isAuthenticated`: true
   - **Invalid/Missing Token**:
     - AuthProvider sets `user`: null
     - AuthProvider sets `loading`: false
     - AuthProvider sets `isAuthenticated`: false

5. **Route Protection**
   - **Skill**: Frontend Routing Skill
   - **Agent**: Frontend Implementation Agent
   - **Valid Token**: Allow access to protected routes (dashboard)
   - **Invalid Token**: Redirect to `/login` page

6. **User Experience**
   - **Valid Token**: User is automatically logged in, sees dashboard
   - **Invalid Token**: User sees login page

---

### 3.5 Token Expiration Handling (401 Response)

**Purpose**: Handle expired JWT token during API requests

**Flow Conceptual Steps:**

1. **API Request**
   - Component calls API client function (e.g., api.getTasks())
   - API client attaches JWT token to Authorization header

2. **Backend Response**
   - **Backend Responsibility (Authentication Skill)**:
     - Validate JWT token signature
     - Check token expiration (must be within 24 hours)
   - **Invalid/Expired Token**: Return 401 Unauthorized

3. **Response Handling**
   - **Skill**: Frontend API Client Skill
   - **Agent**: Frontend Implementation Agent
   - API client receives 401 response

4. **Token Cleanup**
   - **Skill**: Frontend API Client Skill
   - **Agent**: Frontend Implementation Agent
   - Remove JWT token from `localStorage.removeItem('auth_token')`

5. **State Updates**
   - **Skill**: Frontend State Management Skill
   - **Agent**: Frontend Implementation Agent
   - AuthProvider.logout() called (triggered by 401)
   - Auth state updates:
     - `user`: null
     - `loading`: false
     - `isAuthenticated`: false

6. **Notifications**
   - **Skill**: Frontend Notification Skill
   - **Agent**: Frontend Implementation Agent
   - Show error toast: "Your session has expired. Please log in again."

7. **Redirect**
   - **Skill**: Frontend Routing Skill
   - **Agent**: Frontend Implementation Agent
   - Navigate to `/login` page

---

## 4. Protected Route Handling

### 4.1 AuthGuard Concept

**Purpose**: Protect routes that require authentication

**AuthGuard Rules (Conceptual):**
- Protected routes: `/` (dashboard), `/tasks/:taskId`
- Public routes: `/login`, `/register`
- AuthGuard checks authentication before rendering protected routes

### 4.2 AuthGuard Flow

**Protected Route Mount:**
1. Route attempts to render (e.g., user navigates to `/`)
2. AuthGuard component checks authentication status
3. **Skill**: Frontend State Management Skill
   - Check `isAuthenticated` from AuthContext
4. **Auth Check:**
   - **Authenticated**: Allow route to render
   - **Unauthenticated**: Redirect to `/login`

**Authentication Check Flow:**
```
AuthContext
  ├─ Check user state (user !== null)
  ├─ Check token presence in localStorage
  ├─ If authenticated: return true
  └─ If unauthenticated: return false

AuthGuard
  ├─ Receive auth status
  ├─ If authenticated: render children (protected route)
  └─ If unauthenticated: redirect to /login
```

### 4.3 Component Rendering Rules

**Authentication Status = True:**
- Render protected route content
- Display user information in Header
- Allow API calls with JWT token

**Authentication Status = False:**
- Redirect to `/login` page
- Show loading state during auth check
- Do NOT render protected route content

---

## 5. JWT Handling (Frontend Perspective)

### 5.1 JWT Token Storage (Conceptual)

**Storage Location**: `localStorage.getItem('auth_token')`

**Storage Logic:**
- **Login Response**: Store `access_token` in localStorage
- **Logout**: Remove token from localStorage
- **Token Expiration**: Token removed by 401 response handler

**Token Content (Conceptual):**
- JWT signed by backend (Authentication Skill)
- Contains user claims: `{ user_id, email, name }`
- Expiration time: 24 hours from issuance
- Algorithm: HS256

### 5.2 JWT Token Retrieval

**Retrieval Logic:**
```
API Client
  ├─ Request to make (e.g., GET /api/123/tasks)
  ├─ Retrieve token: localStorage.getItem('auth_token')
  ├─ Check token presence
  ├─ If token exists:
  │   ├─ Attach to Authorization header: "Bearer {token}"
  │   └─ Send request to backend
  └─ If token missing:
      ├─ Return error (for protected endpoints)
      └─ Or don't make request (for public endpoints)
```

### 5.3 JWT Token Usage

**All Protected Requests Include Token:**
- Header: `Authorization: Bearer {token}`
- Scope: Token attached by API client automatically
- Validated by backend (Authentication Skill)

**Request Flow:**
```
Component
  ↓
Calls API client: api.getTasks()
  ↓
API Client
  ├─ Retrieves token from localStorage
  ├─ Attaches token to Authorization header
  ├─ Sends request to backend
  └─ Handles 401 (token expired) responses
```

---

## 6. Boundaries

### 6.1 Frontend Does NOT

**Credential Verification:**
- Frontend does NOT verify email format against backend rules
- Frontend does NOT check password hash
- Frontend does NOT validate password against database
- **Frontend Responsibility**: Client-side validation (format, length) only

**JWT Validation:**
- Frontend does NOT verify JWT signature
- Frontend does NOT validate JWT expiration
- **Frontend does NOT extract/verify token claims
- **Backend Responsibility (Authentication Skill)**: Token validation

**User Data Validation:**
- Frontend does NOT check user existence in database
- Frontend does NOT verify user permissions
- **Backend Responsibility**: User data validation

### 6.2 Frontend DOES (Conceptually)

**Client-Side Validation:**
- **Frontend Form Handling Skill**: Validates form inputs
  - Email format validation
  - Password length validation (min 8 characters)
  - Password confirmation match
  - Required field validation
- Display inline validation errors

**Token Storage:**
- **Frontend API Client Skill**:
  - Store JWT token in localStorage on successful login
  - Retrieve JWT token for API requests
  - Remove JWT token on logout

**State Management:**
- **Frontend State Management Skill**:
  - Manage authentication state (user, loading, isAuthenticated)
  - Provide login() and logout() methods
  - Update state on auth events

**Error Display:**
- **Frontend Notification Skill**:
  - Show success/error messages via toasts
  - Provide user-friendly error messages

**Route Protection:**
- **Frontend Routing Skill**:
  - Check authentication status
  - Redirect unauthenticated users to /login
  - Allow authenticated users to protected routes

### 6.3 All Sensitive Operations Are Handled by Backend

**Backend Responsibilities (Authentication Skill):**
- Generate JWT tokens
- Validate JWT tokens (signature, expiration, claims)
- Verify user credentials (email, password)
- Hash passwords (bcrypt, cost factor 12)
- Validate email uniqueness
- Enforce password policies
- Enforce user data isolation
- Validate user ownership of resources

---

## 7. Multi-User Isolation Enforcement

### 7.1 User ID Extraction (Backend Responsibility)

**Source**: JWT token claims

**Backend Logic (Authentication Skill):**
- Extract `user_id` from JWT token claims
- Validate `user_id` exists in database
- Verify user is active (not suspended/deleted)

### 7.2 User ID in Frontend (Conceptual)

**Frontend Logic:**
- Token includes `user_id` in claims
- Frontend can decode token to extract `user_id` (optional for display)
- Frontend does NOT need to validate `user_id`

### 7.3 User ID in API Requests

**Request Flow:**
```
Component
  ↓
Calls API client: api.getTasks()
  ↓
API Client
  ├─ Retrieves JWT token from localStorage
  ├─ Attaches token to Authorization header
  ├─ Sends request to backend
  └─ Backend extracts user_id from token
```

**Path Parameter:**
- API client includes `user_id` in request path: `/api/{user_id}/tasks`
- `user_id` extracted from JWT token (backend)
- Frontend may include `user_id` for clarity (sanity check)

### 7.4 Isolation Enforcement

**Frontend:**
- Never request other users' tasks
- Never send other users' IDs
- Never attempt to bypass user isolation

**Backend (Authentication Skill):**
- Validate `user_id` (from token) matches `user_id` (from path)
- Reject cross-user access attempts (403 Forbidden)
- Filter all queries by `user_id`

---

## 8. Orchestration Summary

### 8.1 Signup Flow Orchestration

```
User Action: Submit Registration Form
  ↓
[Frontend Form Handling Skill] Validate Form
  ↓
[Frontend Implementation Agent] Generate register() function
  ↓
[Frontend API Client Skill] API Call: POST /api/auth/register
  ↓
[Authentication Skill - Backend] Process Registration
  ├─ Validate email uniqueness
  ├─ Hash password (bcrypt)
  ├─ Create user record
  └─ Return user data
  ↓
[Frontend API Client Skill] Handle Response
  ↓
[Frontend Notification Skill] Show Success Toast
  ↓
[Frontend Routing Skill] Redirect to /login
```

### 8.2 Login Flow Orchestration

```
User Action: Submit Login Form
  ↓
[Frontend Form Handling Skill] Validate Form
  ↓
[Frontend Implementation Agent] Generate login() function
  ↓
[Frontend API Client Skill] API Call: POST /api/auth/login
  ├─ Attach credentials to request
  └─ Send to backend
  ↓
[Authentication Skill - Backend] Process Login
  ├─ Retrieve user by email
  ├─ Verify password hash
  ├─ Generate JWT token
  └─ Return token + user data
  ↓
[Frontend API Client Skill] Handle Response
  ├─ Store JWT token in localStorage
  └─ Return user data
  ↓
[Frontend State Management Skill] Update AuthProvider
  ├─ Set user state
  ├─ Set isAuthenticated = true
  └─ Set loading = false
  ↓
[Frontend Notification Skill] Show Success Toast
  ↓
[Frontend Routing Skill] Redirect to Dashboard (/)
```

### 8.3 Logout Flow Orchestration

```
User Action: Click Logout Button
  ↓
[Frontend State Management Skill] Update AuthProvider
  ├─ Set user = null
  ├─ Set isAuthenticated = false
  └─ Set loading = false
  ↓
[Frontend API Client Skill] Remove JWT Token
  └─ localStorage.removeItem('auth_token')
  ↓
[Frontend Notification Skill] Show Success Toast
  ↓
[Frontend Routing Skill] Redirect to Login (/login)
```

### 8.4 Token Expiration Flow Orchestration

```
API Request with Expired Token
  ↓
[Authentication Skill - Backend] Validate Token
  ├─ Check token signature
  ├─ Check token expiration
  └─ Return 401 Unauthorized
  ↓
[Frontend API Client Skill] Handle 401 Response
  ├─ Remove JWT token from localStorage
  └─ Return error object
  ↓
[Frontend State Management Skill] Update AuthProvider
  └─ Trigger logout() (user = null, isAuthenticated = false)
  ↓
[Frontend Notification Skill] Show Error Toast
  └─ "Session expired. Please log in again."
  ↓
[Frontend Routing Skill] Redirect to Login (/login)
```

---

## 9. Compliance with Governing Specs

### 9.1 Constitution Compliance

- **Spec-Driven Development**: All authentication flows reference specifications
- **Zero Manual Coding**: Flows generated by agents using skills
- **Multi-User Isolation**: All flows enforce user-specific access
- **Security First**: JWT tokens stored securely, credentials validated by backend
- **Technology Stack**: Next.js, TypeScript, Tailwind CSS

### 9.2 Skill Compliance

**Authentication Skill**:
- Provides reasoning for authentication decisions
- Defines token lifecycle rules
- Enforces session security policies

**Frontend API Client Skill**:
- Handles JWT token storage and retrieval
- Attaches tokens to requests
- Handles 401 responses

**Frontend State Management Skill**:
- Designs AuthProvider state structure
- Defines login/logout methods
- Manages authentication state

**Frontend Notification Skill**:
- Displays success/error messages
- Provides user feedback for auth events

### 9.3 Architecture Compliance

**Frontend Architecture** (`/specs/ui/frontend-architecture.md`):
- AuthProvider wraps entire application
- API client centralizes all backend communication
- Protected routes check authentication via AuthContext
- Unauthenticated users redirected to `/login`

**Frontend Pages** (`/specs/ui/pages.md`):
- `/login` page for login flow
- `/register` page for signup flow
- `/` (dashboard) requires authentication

---

## 10. Evolution Path

### 10.1 Phase II Current Scope

**Implemented:**
- User registration flow
- User login flow
- User logout flow
- JWT token storage in localStorage
- Auto-login on app load
- Protected route handling
- Token expiration handling
- Multi-user isolation enforcement
- Error notifications

### 10.2 Future Enhancements (Phase III+)

**Additional Features:**
- Automatic token refresh (before expiration)
- Remember me functionality (persistent sessions)
- Two-factor authentication (2FA)
- OAuth integration (Google, GitHub, etc.)
- Social login buttons
- Password reset flow (forgot password)
- Email verification
- Account deletion flow
- Session management (view active sessions, revoke sessions)
- Biometric authentication (fingerprint, face ID)

**Enhanced Features:**
- Token blacklisting (immediate logout)
- Concurrent session limits
- Device management (authorized devices list)
- Session timeout with warning
- Inactivity timeout (auto logout after inactivity)
- Security logging (login attempts, failed logins, IP tracking)
- CAPTCHA integration for login/signup

---

**Version History:**
- **v1.0** (2026-01-02): Initial frontend authentication flow specification for Phase II
