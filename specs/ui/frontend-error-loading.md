# Frontend Error & Loading Specification
**Todo App – Hackathon II – Phase II**

**Version**: 1.0
**Status**: Effective
**Governing Specs**:
- `.specify/memory/constitution.md` - Supreme authority
- `/specs/ui/frontend-architecture.md` - Frontend architecture
- `/specs/ui/pages.md` - Page structure
- `/specs/ui/frontend-components-spec.md` - Component responsibilities
- `/specs/ui/state-management.md` - State ownership boundaries
- `/specs/api/frontend-api-client.md` - API client integration
- `/specs/skills/error-handling-skill.md` - Error handling reasoning
- `/specs/skills/notifications-skill.md` - Notification delivery

---

## 1. Purpose of Error & Loading Specification

This specification defines conceptual architecture for error handling, loading states, and notifications in Todo App Phase II. It establishes how frontend components, state management, API client, and notification systems coordinate to provide clear user feedback, maintain consistent UX, and handle errors gracefully.

**Primary Objectives:**
- Ensure users see clear, actionable error messages
- Maintain consistent loading states across all operations
- Coordinate error propagation from API client to state to components
- Provide timely feedback via notifications (toasts)
- Ensure errors are logged appropriately for debugging
- Maintain deterministic, enforceable error handling patterns

**Non-Objectives:**
- This is NOT an implementation guide (use skills for code generation)
- This does NOT contain actual fetch/axios error handling code
- This does NOT define backend error handling (that's backend responsibility)

---

## 2. Relationship with Constitution, Skills & Agents

### 2.1 Constitution Compliance

**From `.specify/memory/constitution.md`:**
- **Spec-Driven Development**: Error handling must reference specifications
- **Zero Manual Coding**: Error handling generated by agents using skills
- **Multi-User Isolation**: Errors clearly indicate when access is denied
- **Security First**: No sensitive data exposed in error messages
- **Technology Stack**: Next.js, TypeScript, Tailwind CSS

### 2.2 Skill Responsibilities

**Error Handling Skill** (`/specs/skills/error-handling-skill.md`):
- Provides reasoning for error classification
- Defines error logging strategies
- Plans error aggregation and reporting
- Enforces error handling patterns

**Frontend API Client Skill** (`/specs/skills/frontend-api-client-skill.md`):
- Handles API request/response errors
- Categorizes errors (network, client, server)
- Transforms backend error responses to frontend error objects
- Implements 401 token expiration handling

**Frontend State Management Skill** (`/specs/skills/frontend-state-management-skill.md`):
- Plans error state structure
- Designs error state updates
- Plans derived error selectors

**Frontend Notification Skill** (`/specs/skills/notifications-skill.md`):
- Generates toast notification system
- Displays success/error/info/warning messages
- Manages notification lifecycle

**Frontend Form Handling Skill**:
- Validates form inputs
- Provides field-level error feedback
- Displays inline validation errors

### 2.3 Agent Orchestration

**Frontend Implementation Agent**:
- Invokes Error Handling Skill for error classification
- Invokes Frontend API Client Skill for error transformation
- Invokes Frontend State Management Skill for error state updates
- Invokes Frontend Notification Skill for user feedback
- Generates error handling code (try-catch, error boundaries)

**Plan Agent**:
- Designs error handling architecture
- Plans error propagation flow
- Determines error state structure
- Plans notification strategies

---

## 3. Error Handling Guidelines

### 3.1 Error Classification (Conceptual)

**Network Errors:**
- No internet connection
- DNS resolution failure
- Request timeout
- Server unreachable

**Client Errors (4xx Status Codes):**
- **400 Bad Request**: Invalid request data
- **401 Unauthorized**: Missing, invalid, or expired JWT token
- **403 Forbidden**: User lacks permissions (wrong user data)
- **404 Not Found**: Resource does not exist
- **422 Unprocessable Entity**: Validation errors

**Server Errors (5xx Status Codes):**
- **500 Internal Server Error**: Unexpected server error
- **502/503/504 Service Unavailable**: Backend service down
- **509 Rate Limit Exceeded**: Too many requests

**Component Errors:**
- React component rendering errors
- State management errors
- Unhandled exceptions

### 3.2 Error Propagation Flow

**Conceptual Flow:**
```
Component
  ├─ Initiates action (API call, form submit, etc.)
  ↓
API Client
  ├─ Makes HTTP request
  ├─ Attaches JWT token
  └─ Handles response/error
     ├─ Success: Return data to component
     └─ Error: Transform to error object
  ↓
Error Classification
  ├─ Categorize error (network/client/server)
  ├─ Determine severity (info/warning/error)
  └─ Generate user-friendly message
  ↓
State Management
  ├─ Update error state
  ├─ Update loading state (clear loading)
  └─ Component re-renders with error
  ↓
Notification
  ├─ Display toast with error message
  ├─ Auto-dismiss after duration
  └─ Log error for debugging
```

### 3.3 Default Error Messages

**Generic Messages:**
- "Network error. Please check your connection."
- "An unexpected error occurred. Please try again."
- "Server is currently unavailable. Please try again later."

**Specific Messages:**
- "Invalid email or password." (login)
- "Email already exists." (register)
- "Task not found." (404 on task fetch)
- "You do not have permission to access this resource." (403)
- "Your session has expired. Please log in again." (401)

### 3.4 Error Fallback Flows

**Retry Flow:**
- Network error → Show retry option
- Server error (500) → Show retry option
- 500+ status codes → Allow user to retry operation

**Recovery Flow:**
- 401 Unauthorized → Clear token, redirect to /login
- 403 Forbidden → Show error message, user adjusts permissions
- 404 Not Found → Navigate back, show resource not found
- 500 Server Error → Show generic error, logging for debugging

---

## 4. Loading State Guidelines

### 4.1 Global vs Local Loading

**Global Loading:**
- Purpose: Application-wide loading state
- Scope: Affects entire application or major sections
- Usage: App initialization, major data loading
- **Owner**: Not used in Phase II (local only)

**Local Loading:**
- Purpose: Component or operation-specific loading
- Scope: Affects only specific component or operation
- Usage: API calls, form submissions, data fetching
- **Owner**: Individual components

### 4.2 Loading State Lifecycle

**Loading Flow:**
```
Component initiates action
  ↓
Set loading = true
  ├─ Disable buttons/inputs
  ├─ Show loading spinner/indicator
  └─ Component renders loading state
  ↓
Operation completes (success or error)
  ↓
Set loading = false
  ├─ Enable buttons/inputs
  ├─ Hide loading spinner/indicator
  └─ Show data or error
```

### 4.3 Loading Indicator Types

**Spinners:**
- Full-page spinner: Page-level loading
- Inline spinner: Button-level loading
- Component spinner: Data loading in component

**Skeletons:**
- Content placeholder while loading (future enhancement)
- Simulates content structure before data loads

**Progress Bars:**
- File upload progress (future enhancement)
- Multi-step operation progress

**Button Loading State:**
- Disable button while loading
- Show spinner inside button
- Maintain button text or show "Loading..."

### 4.4 Loading State Guidelines

**Best Practices:**
- Show loading state immediately on operation start
- Clear loading state on operation completion (success or error)
- Disable interactive elements during loading
- Provide visual feedback that operation is in progress
- Allow operation cancellation (future enhancement)

**Anti-Patterns:**
- No loading state (poor UX)
- Inconsistent loading across similar operations
- Loading doesn't clear (user thinks it's still loading)
- Loading overlaps without clearing

---

## 5. Notifications & Toasts

### 5.1 Notification Purpose

Provide non-intrusive, timely feedback to users for:
- Success messages (operation completed successfully)
- Error messages (operation failed)
- Warning messages (attention required)
- Info messages (informational)

### 5.2 Notification Types

**Success Notifications:**
- Trigger: Successful operation completion
- Display: Green toast
- Duration: 3 seconds (auto-dismiss)
- Examples:
  - "Task created successfully!"
  - "Task completed!"
  - "Changes saved."

**Error Notifications:**
- Trigger: Operation failure
- Display: Red toast
- Duration: 5 seconds (longer to ensure user sees it)
- Examples:
  - "Failed to create task."
  - "Invalid email or password."
  - "Network error. Please try again."

**Warning Notifications:**
- Trigger: Potential issue, attention needed
- Display: Yellow/Orange toast
- Duration: 5 seconds
- Examples:
  - "Task is overdue."
  - "This task will be deleted in 7 days."

**Info Notifications:**
- Trigger: Informational messages
- Display: Blue toast
- Duration: 3 seconds
- Examples:
  - "5 tasks due today."
  - "Your session will expire in 10 minutes."

### 5.3 Notification Flow

**Notification Flow:**
```
Component triggers event
  ↓
State Management / Component
  ├─ Event completes (success or error)
  ├─ Generate notification message
  └─ Call notification method
  ↓
Notification System
  ├─ Create notification object
  ├─ Add to notification queue
  └─ Display toast component
  ↓
Toast Component
  ├─ Animate in
  ├─ Display message and icon
  ├─ Show auto-dismiss timer
  └─ Allow manual dismiss (click)
  ↓
Auto-Dismiss Timer
  ├─ Wait for duration
  ├─ Animate out
  └─ Remove from queue
```

### 5.4 Toast Guidelines

**Placement:**
- Fixed position (top-right or top-center)
- Stack multiple toasts vertically
- Newest toast on top

**Behavior:**
- Auto-dismiss after specified duration
- Allow manual dismiss (click to close)
- Clicking toast removes it immediately
- Hovering toast pauses auto-dismiss timer

**Visual Design:**
- Success: Green background, dark text, checkmark icon
- Error: Red background, dark text, error icon
- Warning: Orange/Yellow background, dark text, warning icon
- Info: Blue background, dark text, info icon

**Animation:**
- Fade in on display
- Fade out on dismiss
- Smooth transitions

---

## 6. Error & Loading Coordination

### 6.1 Skill Orchestration by Error Type

**Network Errors:**
- **Frontend API Client Skill**: Detects network failure
- **Error Handling Skill**: Classifies as network error
- **Frontend Notification Skill**: Shows offline/error message
- **State Management**: Updates error state (if applicable)

**401 Unauthorized Errors:**
- **Frontend API Client Skill**: Receives 401 response
- **Error Handling Skill**: Classifies as auth error
- **Frontend API Client Skill**: Clears JWT token from localStorage
- **Frontend State Management Skill**: Updates auth state (user = null, isAuthenticated = false)
- **Frontend Notification Skill**: Shows "Session expired" toast
- **Frontend Routing Skill**: Redirects to /login

**403 Forbidden Errors:**
- **Frontend API Client Skill**: Receives 403 response
- **Error Handling Skill**: Classifies as authz error
- **Frontend Notification Skill**: Shows access denied message
- **State Management**: No state update (user remains authenticated)

**404 Not Found Errors:**
- **Frontend API Client Skill**: Receives 404 response
- **Error Handling Skill**: Classifies as not found error
- **Frontend Notification Skill**: Shows resource not found message
- **State Management**: No state update

**Validation Errors (400, 422):**
- **Frontend API Client Skill**: Receives validation error
- **Error Handling Skill**: Classifies as validation error
- **Frontend API Client Skill**: Transforms field-level errors
- **Frontend Form Handling Skill**: Displays errors on form fields
- **Frontend Notification Skill**: Shows generic validation error toast

**Server Errors (500+):**
- **Frontend API Client Skill**: Receives server error
- **Error Handling Skill**: Classifies as server error
- **Frontend Notification Skill**: Shows generic error message
- **Frontend API Client Skill**: Logs error for debugging
- **State Management**: No state update

### 6.2 Loading State Coordination

**API Request Loading:**
- **Component**: Initiates API call
- **State Management**: Sets loading = true
- **Frontend API Client Skill**: Makes request
- **Component**: Renders loading state while waiting
- **Success**: Loading cleared, data displayed
- **Error**: Loading cleared, error displayed

**Form Submission Loading:**
- **Component**: User submits form
- **Frontend Form Handling Skill**: Validates form
- **State Management**: Sets loading = true
- **Frontend API Client Skill**: Makes request
- **Component**: Shows loading spinner on button
- **Success**: Loading cleared, success notification shown
- **Error**: Loading cleared, error notifications shown

### 6.3 Error State Coordination

**Error State Update Flow:**
```
API Client receives error
  ↓
Error Handling Skill classifies error
  ↓
State Management updates error state
  ├─ set error: error object
  ├─ set loading: false
  └─ Component re-renders with error
```

**Error Display Flow:**
```
Component re-renders with error state
  ↓
Frontend Form Handling Skill (for form errors)
  ├─ Display field-level errors (red border, error text)
  └─ Show inline validation messages
  ↓
Frontend Notification Skill (for non-form errors)
  ├─ Show toast notification
  └─ Auto-dismiss after duration
```

---

## 7. Boundaries

### 7.1 Components Remain Dumb

**Component Responsibilities:**
- Display loading indicators when loading = true
- Display error messages when error is set
- Call API client functions
- Display validation errors inline
- Trigger notifications for user feedback
- Manage local loading state (useState for form submissions)

**Component Does NOT:**
- Retry API calls automatically
- Clear global error state
- Manage notifications directly (use ToastProvider hook)
- Validate JWT token signatures (backend responsibility)
- Make authentication decisions (use AuthContext)

### 7.2 State Management Responsibilities

**AuthProvider Responsibilities:**
- Manage authentication state (user, isAuthenticated, loading)
- Provide login() and logout() methods
- Clear token on logout
- Trigger 401 handling (clear state, redirect to login)

**ToastProvider Responsibilities:**
- Manage notification queue
- Provide showToast() method to components
- Auto-dismiss notifications after duration
- Render toast components

**Page-Level State (Dashboard, etc.) Responsibilities:**
- Manage local loading state (for API calls)
- Manage local error state (for display)
- Call API client functions
- Update local state with API responses

### 7.3 All Sensitive Operations Handled by Backend

**Frontend Does NOT:**
- Validate JWT token signature
- Check token expiration (except on 401 response)
- Verify user credentials
- Hash passwords
- Validate email format against backend rules
- Check user existence in database
- Validate user permissions

**Backend (Authentication Skill) Responsibilities:**
- Generate JWT tokens
- Validate JWT tokens (signature, expiration, claims)
- Verify user credentials
- Hash passwords (bcrypt, cost factor 12)
- Validate email uniqueness
- Enforce password policies
- Enforce multi-user data isolation

---

## 8. Interaction Rules

### 8.1 Components Must Use Notification System

**Allowed Patterns:**
- **Success**: Show success toast after successful operation
- **Error**: Show error toast after failed operation
- **Info**: Show info toast for informational messages
- **Warning**: Show warning toast for attention-needed messages

**Notification Method:**
```typescript
// Components MUST use notification system
const { showToast } = useToast();

// Success notification
showToast('Task created successfully!', 'success');

// Error notification
showToast('Failed to create task', 'error', 5000);
```

**Forbidden Patterns:**
- ❌ Use alert() directly (use ToastProvider instead)
- ❌ Show inline error messages without toast
- ❌ Don't show notifications for successful operations

### 8.2 Error Display Rules

**Form Errors:**
- Show field-level errors inline (red border, error text below input)
- Don't show toast for form validation errors
- Allow user to correct and resubmit

**API Errors:**
- Show toast notification for all API errors
- Include user-friendly error message
- Log errors for debugging (development only)
- Clear loading state on error

**Network Errors:**
- Show "Network error" toast
- Provide retry option in UI
- Allow user to retry operation manually

### 8.3 Loading State Rules

**Loading During API Call:**
- Set loading = true before API call
- Show loading indicator (spinner, disabled button)
- Clear loading = true after API response (success or error)
- Never leave loading state stuck

**Loading During Form Submission:**
- Set loading = true on form submit
- Disable submit button
- Show spinner in button
- Clear loading = true after response
- Enable submit button

**Multiple Concurrent Operations:**
- Each component manages its own loading state
- Use local loading for operation-specific loading
- Global loading not used in Phase II

---

## 9. Orchestration Summary

### 9.1 API Error Flow Orchestration

```
Component calls API function
  ↓
[Frontend API Client Skill] HTTP Request
  ├─ Attaches JWT token
  ├─ Sends request to backend
  └─ Receives response
  ↓
[Error Handling Skill] Classify Error
  ├─ Network error → offline message
  ├─ 401 Unauthorized → clear token, redirect to login
  ├─ 403 Forbidden → access denied message
  ├─ 404 Not Found → resource not found message
  ├─ 400/422 Validation → field-level errors
  └─ 500+ Server → generic error message
  ↓
[Frontend State Management] Update Error State
  ↓
[Frontend Notification Skill] Show Toast
  └─ Auto-dismiss after duration
```

### 9.2 Loading State Flow Orchestration

```
Component initiates operation
  ↓
[Frontend State Management] Set loading = true
  ↓
Component Renders Loading Indicator
  ├─ Disable interactive elements
  └─ Show spinner
  ↓
Operation Completes (success or error)
  ↓
[Frontend State Management] Set loading = false
  ↓
Component Renders Result
  ├─ Show data or error message
  └─ Enable interactive elements
```

### 9.3 Form Validation Flow Orchestration

```
User submits form
  ↓
[Frontend Form Handling Skill] Validate Input
  ├─ Email format validation
  ├─ Password length validation
  ├─ Required field validation
  └─ Show inline errors if invalid
  ↓
[Frontend State Management] Set loading = true (if valid)
  ↓
[Frontend API Client Skill] API Call
  ↓
[Error Handling Skill] Classify Response
  ├─ Success: Clear errors, show success toast
  └─ Error: Show field-level errors or toast
  ↓
[Frontend State Management] Set loading = false
```

---

## 10. Compliance with Governing Specs

### 10.1 Constitution Compliance

- **Spec-Driven Development**: Error handling flows reference specifications
- **Zero Manual Coding**: Error handling generated by agents using skills
- **Multi-User Isolation**: Errors clearly indicate user-specific access issues
- **Security First**: No sensitive data in error messages
- **Technology Stack**: Next.js, TypeScript, Tailwind CSS

### 10.2 Skill Compliance

**Error Handling Skill**:
- Provides reasoning for error classification
- Defines error logging strategies
- Enforces error handling patterns

**Frontend API Client Skill**:
- Handles API request/response errors
- Categorizes errors (network, client, server)
- Implements 401 token expiration handling

**Frontend State Management Skill**:
- Plans error state structure
- Designs error state updates

**Frontend Notification Skill**:
- Generates toast notification system
- Displays success/error/info/warning messages

**Frontend Form Handling Skill**:
- Validates form inputs
- Provides field-level error feedback

### 10.3 Architecture Compliance

**Frontend Architecture** (`/specs/ui/frontend-architecture.md`):
- ToastProvider manages notification state
- Components use useToast() hook
- Error handling standardized across all components
- Loading states managed locally by components

**Frontend Components Spec** (`/specs/ui/frontend-components-spec.md`):
- Components display loading states
- Components display error messages
- Components use ToastProvider for notifications

**Frontend API Client Spec** (`/specs/api/frontend-api-client.md`):
- API client transforms backend errors to frontend error objects
- API client handles 401 responses (token expiration)

---

## 11. Evolution Path

### 11.1 Phase II Current Scope

**Implemented:**
- Error classification (network, client, server)
- Loading state management (local, per component)
- Toast notification system (success, error, info, warning)
- API error handling (401, 403, 404, 500+)
- Form validation with inline error display
- Error logging (conceptual, actual logs generated by backend)
- 401 token expiration handling (clear token, redirect to login)
- Retry support for network errors

### 11.2 Future Enhancements (Phase III+)

**Additional Error Handling:**
- Automatic retry with exponential backoff for transient errors
- Error boundary for React component error catching
- Error reporting to monitoring service (Sentry, etc.)
- Offline detection and queueing (save operations, retry when online)
- Error caching (don't show same error twice)
- Undo functionality for operations (restore state before error)

**Enhanced Loading:**
- Skeleton screens for improved perceived performance
- Progressive loading indicators for large datasets
- Cancellation tokens (AbortController) for request cancellation
- Concurrent operation management (multiple spinners)
- Loading state persistence across route changes

**Enhanced Notifications:**
- Browser push notifications (for task reminders, due dates)
- Email notifications (for task summaries, overdue tasks)
- In-app notification center
- Notification preferences (enable/disable, timing, sounds)
- Notification grouping and batching
- Notification history log

**Advanced Features:**
- Error analytics dashboard
- Error rate tracking
- A/B testing for error messages
- User feedback on errors (report issue button)
- Error severity levels and routing
- Maintenance mode announcements

---

**Version History:**
- **v1.0** (2026-01-02): Initial frontend error & loading specification for Phase II
